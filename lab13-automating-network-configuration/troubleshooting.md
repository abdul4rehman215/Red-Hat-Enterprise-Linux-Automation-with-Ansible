# üõ†Ô∏è troubleshooting Guide ‚Äî Lab 13: Automating Network Configuration (Ansible)

> This file documents common issues encountered during automated network configuration using Ansible + NetworkManager (`nmcli`), along with fixes and verification steps.

---

## üß© Issue 1: NetworkManager Service Not Running

### ‚ùó Problem
`nmcli` tasks fail with:
- `NetworkManager is not running`
- `Error: NetworkManager is not running.`
- connection changes do not apply

### ‚úÖ Cause
NetworkManager service is stopped/disabled on managed nodes.

### ‚úÖ Fix (Ansible)
```bash
ansible -i inventory all -m service -a "name=NetworkManager state=started enabled=yes" --become
````

### üìå Output (example)

```text
node1 | SUCCESS => {"changed": false, "enabled": true, "name": "NetworkManager", "state": "started"}
node2 | SUCCESS => {"changed": false, "enabled": true, "name": "NetworkManager", "state": "started"}
```

### ‚úÖ Verification

```bash
ansible -i inventory all -m shell -a "systemctl status NetworkManager --no-pager"
ansible -i inventory all -m shell -a "nmcli general status"
```

---

## üåê Issue 2: DNS Resolution Failures After Applying DNS Changes

### ‚ùó Problem

After updating DNS settings, lookups fail:

* `nslookup: connection timed out`
* `Temporary failure in name resolution`
* applications cannot resolve domains

### ‚úÖ Cause

Common causes include:

* `/etc/resolv.conf` content not updated correctly
* NetworkManager not restarted after changes
* incorrect DNS server entries
* resolver priority mismatch in `/etc/nsswitch.conf`

### ‚úÖ Fix Step 1: Verify `/etc/resolv.conf`

```bash
ansible -i inventory all -m shell -a "cat /etc/resolv.conf"
```

### üìå Output (example)

```text
# Generated by Ansible - Lab 13
# Search domains
search example.com
search lab.local
search internal.net
# DNS servers
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 1.1.1.1
# DNS options
options timeout:2
options attempts:3
options rotate
```

### ‚úÖ Fix Step 2: Restart NetworkManager

```bash
ansible -i inventory all -m service -a "name=NetworkManager state=restarted" --become
```

### üìå Output (example)

```text
node1 | SUCCESS => {"changed": true, "name": "NetworkManager", "state": "started"}
node2 | SUCCESS => {"changed": true, "name": "NetworkManager", "state": "started"}
```

### ‚úÖ Fix Step 3: Test DNS Using nslookup

```bash
ansible -i inventory all -m shell -a "nslookup google.com"
```

### ‚úÖ Optional Validation: Use `dig` (if installed)

In minimal images, `dig` may not exist:

```bash
ansible -i inventory all -m shell -a "dig @8.8.8.8 google.com | head"
```

If missing:

```bash
ansible -i inventory all -m yum -a "name=bind-utils state=present" --become
```

Then retry:

```bash
ansible -i inventory all -m shell -a "dig @8.8.8.8 google.com | head"
```

### üìå Output (example)

```text
node1 | CHANGED | rc=0 >>
; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.16 <<>> @8.8.8.8 google.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18234
```

---

## üõ£Ô∏è Issue 3: Static Routes Not Persisting After Reboot

### ‚ùó Problem

Routes appear correctly after the playbook runs, but disappear after reboot or network restart.

### ‚úÖ Cause

Routes may be:

* applied only at runtime
* missing from persistent route configuration files
* not stored in the NetworkManager connection profile

### ‚úÖ Fix Step 1: Check route persistence files

```bash
ansible -i inventory all -m shell -a "ls -la /etc/sysconfig/network-scripts/route-*"
```

### üìå Output (example)

```text
node1 | CHANGED | rc=0 >>
-rw-r--r-- 1 root root 104 Aug 20 11:29 /etc/sysconfig/network-scripts/route-eth0

node2 | CHANGED | rc=0 >>
-rw-r--r-- 1 root root 104 Aug 20 11:29 /etc/sysconfig/network-scripts/route-eth0
```

### ‚úÖ Fix Step 2: Confirm routes exist in NetworkManager profiles

```bash
ansible -i inventory all -m shell -a "nmcli connection show"
```

### üìå Output (example)

```text
node1 | CHANGED | rc=0 >>
NAME                 UUID                                  TYPE      DEVICE
primary-eth0          7c1c2fd0-4d1f-4b3c-8f04-1d13a5d3b100  ethernet  eth0
System eth0           1b5f8b31-3a7a-4c15-8f7d-4b2f2e4d1f10  ethernet  --
secondary-net         22c3a0bb-7f4b-4b92-8af2-8f2f8b5a3a10  ethernet  --
```

### ‚úÖ Verification

```bash
ansible -i inventory all -m shell -a "ip route show"
```

---

## üîå Issue 4: Connection Profile Created but Not Active (`DEVICE --`)

### ‚ùó Problem

`nmcli connection show` shows:

* `secondary-net ... DEVICE --`

### ‚úÖ Cause

The connection profile exists but is not brought up, or another profile is already bound to the interface.

### ‚úÖ Fix

Bring the connection up explicitly:

```bash
ansible -i inventory all -m shell -a "nmcli connection up secondary-net" --become
```

Then verify:

```bash
ansible -i inventory all -m shell -a "nmcli connection show --active"
```

---

## üß± Issue 5: Host Becomes Unreachable After IP Change

### ‚ùó Problem

After applying static IP changes, Ansible cannot reach node(s) anymore.

### ‚úÖ Cause

* Inventory still points to old `ansible_host`
* Network change applied but access path depends on original IP
* Cloud routing/security groups restrict new subnet/IP

### ‚úÖ Fix Options

1. **Update inventory** to match the new reachable IP:

```ini
node1 ansible_host=192.168.1.100
node2 ansible_host=192.168.1.101
```

2. If you must keep old connectivity, apply IP changes in a maintenance window and ensure console access exists.

3. Validate reachability from controller:

```bash
ping -c 3 192.168.1.100
ping -c 3 192.168.1.101
```

---

## ‚úÖ Quick Validation Checklist (Post-Run)

Run these to confirm everything is stable:

```bash
ansible -i inventory all -m shell -a "ip addr show"
ansible -i inventory all -m shell -a "nmcli device status"
ansible -i inventory all -m shell -a "nmcli connection show --active"
ansible -i inventory all -m shell -a "ip route show"
ansible -i inventory all -m shell -a "cat /etc/resolv.conf"
ansible -i inventory all -m shell -a "nslookup google.com"
```

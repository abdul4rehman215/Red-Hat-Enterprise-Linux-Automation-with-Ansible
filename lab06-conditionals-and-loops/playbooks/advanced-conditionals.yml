# playbooks/lab6/advanced-conditionals.yml
---
- name: Advanced Conditionals Demo
  hosts: all
  gather_facts: yes
  vars:
    required_memory_gb: 2
    required_disk_space_gb: 10

  tasks:
    - name: Gather installed package facts
      package_facts:
        manager: auto

    - name: Check if system meets memory requirements
      debug:
        msg: "System has {{ ansible_memtotal_mb // 1024 }}GB RAM - meets requirements"
      when: (ansible_memtotal_mb // 1024) >= required_memory_gb

    - name: Warning for insufficient memory
      debug:
        msg: "WARNING: System has only {{ ansible_memtotal_mb // 1024 }}GB RAM"
      when: (ansible_memtotal_mb // 1024) < required_memory_gb

    - name: Install monitoring tools on servers with sufficient resources
      yum:
        name:
          - htop
          - iotop
          - nethogs
        state: present
      when:
        - (ansible_memtotal_mb // 1024) >= required_memory_gb
        - ansible_os_family == "RedHat"

    - name: Configure firewall (only if firewalld is installed)
      firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes
      when:
        - ansible_os_family == "RedHat"
        - ansible_facts.packages.firewalld is defined
      ignore_errors: yes

    - name: Create backup directory (only on weekends)
      file:
        path: /opt/weekend-backup
        state: directory
        mode: '0755'
      when: ansible_date_time.weekday in ['Saturday', 'Sunday']

# playbooks/lab6/loop-control.yml
---
- name: Loop Control Demo
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    packages_to_install:
      - name: "git"
        required: true
      - name: "docker"
        required: false
      - name: "nodejs"
        required: true
      - name: "python3-pip"
        required: true
      - name: "mongodb"
        required: false

  tasks:
    - name: Install only required packages
      package:
        name: "{{ item.name }}"
        state: present
      loop: "{{ packages_to_install }}"
      when: item.required == true

    - name: Create numbered backup directories
      file:
        path: "/backup/backup-{{ idx }}"
        state: directory
        mode: '0755'
      loop:
        - daily
        - weekly
        - monthly
      loop_control:
        index_var: idx

    - name: Process items with custom loop variable name
      debug:
        msg: "Processing {{ current_item.name }} (Required: {{ current_item.required }})"
      loop: "{{ packages_to_install }}"
      loop_control:
        loop_var: current_item

    - name: Install packages with pause between installations
      block:
        - name: Install package
          package:
            name: "{{ item }}"
            state: present
        - name: Pause after installation
          pause:
            seconds: 2
      loop:
        - curl
        - wget
        - rsync
